<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for Windows (x86-64) 2014.1 (Build 608)" ts="2014-04-02 16:26:28">
<Class name="Training.DeepSee.Address">
<Super>%SerialObject,%Populate,%XML.Adaptor,%ZEN.DataModel.Adaptor</Super>
<TimeChanged>63026,59260.294542</TimeChanged>
<TimeCreated>62398,36968.308431</TimeCreated>

<Property name="Street">
<Description>
The street address.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="80"/>
<Parameter name="POPSPEC" value="Street()"/>
</Property>

<Property name="City">
<Description>
The city name.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="80"/>
<Parameter name="POPSPEC" value="City()"/>
</Property>

<Property name="State">
<Description>
The 2-letter state abbreviation.</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="2"/>
<Parameter name="POPSPEC" value="USState()"/>
</Property>

<Storage name="Default">
<Type>%Library.CacheSerialState</Type>
<State>AddressState</State>
<StreamLocation>^Training.DeepSee.AddressS</StreamLocation>
<Data name="AddressState">
<Value name="1">
<Value>Street</Value>
</Value>
<Value name="2">
<Value>City</Value>
</Value>
<Value name="3">
<Value>State</Value>
</Value>
<Value name="4">
<Value>Zip</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="Training.DeepSee.Customer">
<Super>%Persistent,%Populate,%XML.Adaptor</Super>
<TimeChanged>63279,56785.39334</TimeChanged>
<TimeCreated>61513,40580.746548</TimeCreated>
<Inheritance>right</Inheritance>

<Property name="Name">
<Type>%String</Type>
</Property>

<Property name="Channel">
<Type>%String</Type>
<Parameter name="DISPLAYLIST" value=",Retail Only,Online Only,Retail &amp; Online"/>
<Parameter name="VALUELIST" value=",1,2,3"/>
</Property>

<Property name="CustomerID">
<Type>%String</Type>
<Parameter name="MAXLEN" value="10"/>
</Property>

<Property name="Address">
<Type>Training.DeepSee.Address</Type>
</Property>

<Index name="CustomerIDIndex">
<Properties>CustomerID</Properties>
<Unique>1</Unique>
</Index>

<Parameter name="DSTIME">
<Description><![CDATA[
If the <var>DSTIME</var> parameter is set to AUTO then the most recent filing operation in the current DSTIME value 
for each object will be recorded in a global, ^OBJ.DSTIME: 
<br>
	^OBJ.DSTIME(<var>ExtentName</var>,<var>DSTIME</var>,<var>objectID</var>) = <var>filing operation</var> 
<br>
For DSTIME=AUTO the DSTIME value is recorded in ^OBJ.DSTIME and is set by the consumer of DSTIME data.
<br>
Refer to %DeepSee documentation for more information on how DSTIME is used by %DeepSee. 
<br>
The filing operations are:
<table>
<tr><th align="left">Code</th><th align="left">Operation</th>
<tr><td>0</td><td align="center">Update</td></tr>
<tr><td>1</td><td align="center">Insert</td></tr>
<tr><td>2</td><td align="center">Delete</td></tr>
</table>
<br>
If the <var>DSTIME</var> parameter is set to MANUAL then the user is responsible for journaling object filing operations.]]></Description>
<Type>STRING</Type>
<Constraint>,AUTO,MANUAL</Constraint>
<Default>AUTO</Default>
<Flags>ENUM</Flags>
</Parameter>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^Training.DeepSee.CustomerD</DataLocation>
<DefaultData>CustomerDefaultData</DefaultData>
<IdLocation>^Training.DeepSee.CustomerD</IdLocation>
<IndexLocation>^Training.DeepSee.CustomerI</IndexLocation>
<StreamLocation>^Training.DeepSee.CustomerS</StreamLocation>
<ExtentSize>499</ExtentSize>
<Data name="CustomerDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>Name</Value>
</Value>
<Value name="3">
<Value>CustomerID</Value>
</Value>
<Value name="4">
<Value>Address</Value>
</Value>
<Value name="5">
<Value>Channel</Value>
</Value>
</Data>
<Property name="%%CLASSNAME">
<Selectivity>100.0000%</Selectivity>
</Property>
<Property name="Address">
<Selectivity>0.2004%,Street:0.2004%</Selectivity>
</Property>
<Property name="Channel">
<Selectivity>33.3333%</Selectivity>
</Property>
<Property name="CustomerID">
<Selectivity>0.2000%</Selectivity>
</Property>
<Property name="Name">
<Selectivity>0.2004%</Selectivity>
</Property>
<SQLMap name="CustomerIDIndex">
<BlockCount>-4</BlockCount>
</SQLMap>
<SQLMap name="IDKEY">
<BlockCount>-20</BlockCount>
</SQLMap>
</Storage>
</Class>


<Class name="Training.DeepSee.CustomerCube">
<Description>
</Description>
<ProcedureBlock>1</ProcedureBlock>
<Super>%DeepSee.CubeDefinition</Super>
<TimeChanged>63029,33008.347958</TimeChanged>
<TimeCreated>63028,59163.177078</TimeCreated>
<DependsOn>Training.DeepSee.Customer</DependsOn>

<Parameter name="DOMAIN">
</Parameter>

<XData name="Cube">
<Description>
Cube definition from Architect.</Description>
<XMLNamespace>http://www.intersystems.com/deepsee</XMLNamespace>
<Data><![CDATA[
<cube xmlns="http://www.intersystems.com/deepsee" name="Customer Cube" displayName="Customer Cube" disabled="false" abstract="false" sourceClass="Training.DeepSee.Customer" countMeasureName="%COUNT" countMeasureCaption="Customers" bucketSize="8" bitmapChunkInMemory="false" precompute="0">
  <dimension name="Channel" disabled="false" hasAll="false" allCaption="All Channel" allDisplayName="Channel" type="data" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level sourceProperty="Channel" name="Channel" disabled="false" list="false" useDisplayValue="false">
        <property sourceProperty="Channel" name="Name" disabled="false" hidden="false" isName="true" isReference="false" useDisplayValue="true"></property>
      </level>
    </hierarchy>
  </dimension>
  <dimension name="Address" disabled="false" hasAll="false" allCaption="All Address" allDisplayName="Address" type="data" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level sourceProperty="Address.State" name="State" disabled="false" list="false" useDisplayValue="true">
      </level>
      <level sourceExpression="%source.Address.City_&quot;: &quot;_%source.Address.State" name="City" disabled="false" list="false" useDisplayValue="true">
      </level>
    </hierarchy>
  </dimension>
</cube>
]]></Data>
</XData>
</Class>


<Class name="Training.DeepSee.Order">
<Super>%Persistent,%Populate,%XML.Adaptor,%ZEN.DataModel.Adaptor</Super>
<TimeChanged>63279,56785.489058</TimeChanged>
<TimeCreated>62398,52987.697078</TimeCreated>

<Property name="Customer">
<Type>Training.DeepSee.Customer</Type>
</Property>

<Property name="SaleDate">
<Type>%Date</Type>
<Parameter name="MAXVAL" value="+$H"/>
<Parameter name="MINVAL" value="59901"/>
</Property>

<Property name="Units">
<Type>%Integer</Type>
<Parameter name="MAXVAL" value="10"/>
</Property>

<Property name="Amount">
<Type>%Numeric</Type>
<Parameter name="MAXVAL" value="1000"/>
</Property>

<Parameter name="DSTIME">
<Description><![CDATA[
If the <var>DSTIME</var> parameter is set to AUTO then the most recent filing operation in the current DSTIME value 
for each object will be recorded in a global, ^OBJ.DSTIME: 
<br>
	^OBJ.DSTIME(<var>ExtentName</var>,<var>DSTIME</var>,<var>objectID</var>) = <var>filing operation</var> 
<br>
For DSTIME=AUTO the DSTIME value is recorded in ^OBJ.DSTIME and is set by the consumer of DSTIME data.
<br>
Refer to %DeepSee documentation for more information on how DSTIME is used by %DeepSee. 
<br>
The filing operations are:
<table>
<tr><th align="left">Code</th><th align="left">Operation</th>
<tr><td>0</td><td align="center">Update</td></tr>
<tr><td>1</td><td align="center">Insert</td></tr>
<tr><td>2</td><td align="center">Delete</td></tr>
</table>
<br>
If the <var>DSTIME</var> parameter is set to MANUAL then the user is responsible for journaling object filing operations.]]></Description>
<Type>STRING</Type>
<Constraint>,AUTO,MANUAL</Constraint>
<Default>AUTO</Default>
<Flags>ENUM</Flags>
</Parameter>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^Training.DeepSee.OrderD</DataLocation>
<DefaultData>OrderDefaultData</DefaultData>
<IdLocation>^Training.DeepSee.OrderD</IdLocation>
<IndexLocation>^Training.DeepSee.OrderI</IndexLocation>
<StreamLocation>^Training.DeepSee.OrderS</StreamLocation>
<ExtentSize>1000</ExtentSize>
<Data name="OrderDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>Customer</Value>
</Value>
<Value name="3">
<Value>SaleDate</Value>
</Value>
<Value name="4">
<Value>Units</Value>
</Value>
<Value name="5">
<Value>Amount</Value>
</Value>
</Data>
<Property name="%%CLASSNAME">
<Selectivity>0.1000%</Selectivity>
<OutlierSelectivity>.992632:</OutlierSelectivity>
</Property>
<Property name="Amount">
<Selectivity>0.1000%</Selectivity>
</Property>
<Property name="Customer">
<Selectivity>0.2435%</Selectivity>
</Property>
<Property name="SaleDate">
<Selectivity>0.1244%</Selectivity>
</Property>
<Property name="Units">
<Selectivity>9.0898%</Selectivity>
</Property>
<SQLMap name="IDKEY">
<BlockCount>-16</BlockCount>
</SQLMap>
</Storage>
</Class>


<Class name="Training.DeepSee.OrderCube">
<Description>
</Description>
<ProcedureBlock>1</ProcedureBlock>
<Super>%DeepSee.CubeDefinition</Super>
<TimeChanged>63029,38202.77443</TimeChanged>
<TimeCreated>63028,33913.792804</TimeCreated>
<DependsOn>Training.DeepSee.Order</DependsOn>

<Parameter name="DOMAIN">
</Parameter>

<XData name="Cube">
<Description>
Cube definition from Architect.</Description>
<XMLNamespace>http://www.intersystems.com/deepsee</XMLNamespace>
<Data><![CDATA[
<cube xmlns="http://www.intersystems.com/deepsee" name="Order Cube" displayName="Order Cube" disabled="false" abstract="false" sourceClass="Training.DeepSee.Order" countMeasureName="%COUNT" countMeasureCaption="Orders" bucketSize="8" bitmapChunkInMemory="false" precompute="0">
  <dimension name="SaleDate" disabled="false" hasAll="false" allCaption="All SaleDate" allDisplayName="SaleDate" sourceProperty="SaleDate" type="time" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level name="Year Sold" disabled="false" timeFunction="Year" list="false" useDisplayValue="true">
      </level>
      <level name="Month Sold" disabled="false" timeFunction="MonthYear" list="false" useDisplayValue="true">
      </level>
      <level name="Day Sold" disabled="false" timeFunction="DayMonthYear" list="false" useDisplayValue="true">
      </level>
    </hierarchy>
  </dimension>
  <dimension name="Customer Address" disabled="false" hasAll="false" allCaption="All Address" allDisplayName="Address" type="data" iKnowType="entity" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level sourceProperty="Customer.Address.State" name="Customer State" disabled="false" timeFunction="DayMonthYear" list="false" useDisplayValue="true">
      </level>
      <level sourceExpression="%source.Customer.Address.City_&quot;: &quot;_%source.Customer.Address.State" name="Customer City" disabled="false" timeFunction="DayMonthYear" list="false" useDisplayValue="true">
      </level>
    </hierarchy>
  </dimension>
  <dimension name="Channel" disabled="false" hasAll="false" allCaption="All Channel" allDisplayName="Channel" type="data" iKnowType="entity" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level sourceProperty="Customer.Channel" name="Channel" disabled="false" list="false" useDisplayValue="false">
        <property sourceProperty="Customer.Channel" name="Name" disabled="false" hidden="false" isName="true" isReference="false" useDisplayValue="true"></property>
      </level>
    </hierarchy>
  </dimension>
  <measure sourceProperty="Amount" name="Amount of Sale" disabled="false" aggregate="SUM" type="number" hidden="false" searchable="false" formatString="$#,###.##"></measure>
  <measure sourceProperty="Units" name="Units Sold" disabled="false" aggregate="SUM" type="number" hidden="false" searchable="false"></measure>
  <relationship sourceProperty="Customer.%ID" name="Customer Cube" disabled="true" relatedCube="Customer Cube" cardinality="one"></relationship>
</cube>
]]></Data>
</XData>
</Class>


<Class name="Training.DeepSee.OrderUtils">
<Super>%RegisteredObject,%XML.Adaptor,%ZEN.DataModel.Adaptor</Super>
<TimeChanged>63236,42447.48702</TimeChanged>
<TimeCreated>62399,31218.021263</TimeCreated>

<Method name="Populate">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
		
		
			Set tSC=##class(Training.DeepSee.Customer).%KillExtent() Quit:$$$ISERR(tSC) tSC
			Set tSC=##class(Training.DeepSee.Order).%KillExtent() Quit:$$$ISERR(tSC) tSC
			Set tSC=##class(Training.DeepSee.Customer).Populate(500) Quit:$$$ISERR(tSC) tSC
			Set tSC=##class(Training.DeepSee.Order).Populate(1000) Quit:$$$ISERR(tSC) tSC

			
			Quit tSC
]]></Implementation>
</Method>

<Method name="UpdateRetailCustomers">
<ClassMethod>1</ClassMethod>
<FormalSpec>percentage:%Numeric=.5</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Set percent=percentage*100
	
	Write "Converting "_percent_" percent of Retail customers to Online & Retail.",!
	
	Set tSC = $$$OK
	
	Set tQuery = "Select Top ? %ID from Training_DeepSee.Customer Where Channel = 1"
	
	Try{
	&sql(SELECT Count(*) into :count from Training_DeepSee.Customer Where Channel=1)
		
	Set tTop = $Number(percentage*count,0)
		
	Set tStmt = ##class(%SQL.Statement).%New()
	Set tStmt.%SelectMode=1
	
	Set tSC = tStmt.%Prepare(tQuery) Quit:$$$ISERR(tSC)
	Set tResultSet = tStmt.%Execute(tTop)
	
	While tResultSet.%Next()
	{
		Set tID = tResultSet.%Get("ID")
		set tCustomer=##class(Training.DeepSee.Customer).%OpenId(tID)
		Set tCustomer.Channel=3
		Set tSC=tCustomer.%Save() Quit:$$$ISERR(tSC)
		
	}
	}
	
	Catch ex {
		
		Set tSC = ex.AsStatus()	
		
	}
	
	Quit tSC
]]></Implementation>
</Method>

<Method name="AddCustomers">
<ClassMethod>1</ClassMethod>
<FormalSpec>num:%Integer=5</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Set tSC=$$$OK
	kill customers
	Set customers = 1
	do ##class(Training.DeepSee.Customer).Populate(num,,,.customers) Quit:customers=0 0
	
	write "The following customers were added:"
	
	Set index=""
	FOR  {
     SET index=$ORDER(customers(index)) 
     QUIT:index=""
     Set tSC = customers(index).%Save() Quit:$$$ISERR(tSC)
     WRITE !,customers(index).Name,!
   }
   
   Quit tSC
]]></Implementation>
</Method>

<Method name="UpdateDSTime">
<Description>
This method provides an example for synchronizing cubes with a single related source class</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pCubeName="",pRemoteClass=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	If pRemoteClass="" Quit $$$ERROR($$$GeneralError,"Remote Class must be defined.")
	If pCubeName="" Quit $$$ERROR($$$GeneralError,"Cube must be defined.")
	Set pCubeName = $$$UPPER(pCubeName)
	Set tSourceClass = $G(^DeepSee.Cubes("cubes",pCubeName,"sourceClass"))
	
	Set tCubeTimeStamp = $G(^DeepSee.Cubes("cubes",pCubeName,"dstime"))
	
	If (tCubeTimeStamp="") {
		Set tCubeTimeStamp=0
	}
	
	// First get the IDs of the other source class
	Set tIDs=""
	While tCubeTimeStamp'="" {
		Set tCurrentID = $O(^OBJ.DSTIME(pRemoteClass,tCubeTimeStamp,""))
		While tCurrentID'="" {
			Set tIDs(tCurrentID) = ""
			Set tCurrentID = $O(^OBJ.DSTIME(pRemoteClass,tCubeTimeStamp,tCurrentID))
		}
		Set tCubeTimeStamp = $O(^OBJ.DSTIME(pRemoteClass,tCubeTimeStamp))
	}
	
	// Convert the collection of IDs to a list for SQL. This may fail if there
	// are too many IDs at once!
	Set tIDList = ""
	Set tID = $O(tIDs(""))
	While tID'="" {
		Set tIDList = tIDList _ $S($L(tIDList)>1:",",1:"") _ tID
		Set tID = $O(tIDs(tID))
	}
	
	// Find the local IDs that are associated with the remote IDs
	Set tSQLTableName = ##class(%DeepSee.Utils).%GetSQLTableName(tSourceClass)
	
	// We could look up the source column that corresponds to the remote class here
	// For now it's hard coded.
	Set tSQL = "SELECT ID FROM "_ tSQLTableName _ " WHERE Customer->ID IN (" _ tIDList _")"
	
	Set tRS = ##class(%SQL.Statement).%ExecDirect(,tSQL)
	
	// The ^OBJ.DSTIME nodes for the cube source class
	Set tSC = $$$OK
	While tRS.%Next() {
		Do ##class(%DeepSee.Utils).%SetDSTimeIndex(tSourceClass,tRS.%Get("ID"),0)
		If $$$ISERR(tSC) Quit
	}
 
	Quit tSC
]]></Implementation>
</Method>
</Class>
</Export>
